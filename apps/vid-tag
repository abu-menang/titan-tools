#!/usr/bin/env bash
# Convenience wrapper for tagging files listed in CSVs using vid_tagger.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
VENV_DIR="${VENV_DIR:-$ROOT_DIR/.venv}"
PYTHON_BIN="${PYTHON_BIN:-python3}"

if [ -d "$VENV_DIR" ]; then
  # shellcheck disable=SC1091
  source "$VENV_DIR/bin/activate"
fi

export PYTHONPATH="${ROOT_DIR}${PYTHONPATH:+:${PYTHONPATH}}"

CONFIG_PATH="${1:-$ROOT_DIR/configs/config.yaml}"
CONFIG_PAYLOAD="$("$PYTHON_BIN" -m common.shared.loader vid_tagger "$CONFIG_PATH")"

"$PYTHON_BIN" - "$CONFIG_PAYLOAD" <<'PY'
import base64
import json
import logging
import sys
from pathlib import Path

from common.base.logging import setup_logging

cfg = json.loads(base64.b64decode(sys.argv[1]).decode("utf-8"))
logging_cfg = cfg.pop("__logging__", {}) or {}

use_rich = logging_cfg.get("use_rich")
if isinstance(use_rich, str):
    lowered = use_rich.strip().lower()
    if lowered == "auto":
        use_rich = None
    elif lowered in {"true", "yes", "1", "on"}:
        use_rich = True
    elif lowered in {"false", "no", "0", "off"}:
        use_rich = False

log_dir_override = Path(cfg["csv_dir"]).expanduser() / "logs" if cfg.get("csv_dir") else None

setup_logging(
    level=logging_cfg.get("level"),
    use_rich=use_rich,
    log_dir=str(log_dir_override) if log_dir_override else logging_cfg.get("log_dir"),
    file_prefix=logging_cfg.get("file_prefix"),
)

log = logging.getLogger("vid_tagger")
log.info("Config loaded for vid_tagger (csv_dir=%s, dry_run=%s, tags=%s)", cfg.get("csv_dir"), cfg.get("dry_run"), cfg.get("tags"))

from video.tagger import tag_files_from_csv_dir

res = tag_files_from_csv_dir(
    cfg["csv_dir"],
    cfg.get("tags"),
    dry_run=bool(cfg.get("dry_run", False)),
)

log.info("Tagging complete: csvs=%s tagged=%s skipped=%s missing=%s", res.get("csvs"), res.get("tagged"), res.get("skipped"), res.get("missing"))
PY
