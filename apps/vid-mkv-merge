#!/usr/bin/env bash
# Repository convenience wrapper for vid-mkv-merge-ext-subs.
# Activates the local virtualenv if present, loads YAML via common.shared.loader,
# and executes the underlying Python workflow.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
VENV_DIR="${VENV_DIR:-$ROOT_DIR/.venv}"
PYTHON_BIN="${PYTHON_BIN:-python3}"

if [ -d "$VENV_DIR" ]; then
  # shellcheck disable=SC1091
  source "$VENV_DIR/bin/activate"
fi

export PYTHONPATH="${ROOT_DIR}${PYTHONPATH:+:${PYTHONPATH}}"

CONFIG_PATH="${1:-$ROOT_DIR/configs/config.yaml}"
CONFIG_PAYLOAD="$($PYTHON_BIN -m common.shared.loader vid_mkv_merge_ext_subs "$CONFIG_PATH")"

"$PYTHON_BIN" - "$CONFIG_PAYLOAD" <<'PY'
import base64
import json
import importlib
import sys
from pathlib import Path

from common.base.logging import setup_logging

cfg = json.loads(base64.b64decode(sys.argv[1]).decode("utf-8"))
logging_cfg = cfg.pop("__logging__", {}) or {}

use_rich = logging_cfg.get("use_rich")
if isinstance(use_rich, str):
    lowered = use_rich.strip().lower()
    if lowered == "auto":
        use_rich = None
    elif lowered in {"true", "yes", "1", "on"}:
        use_rich = True
    elif lowered in {"false", "no", "0", "off"}:
        use_rich = False

setup_logging(
    level=logging_cfg.get("level"),
    use_rich=use_rich,
    log_dir=logging_cfg.get("log_dir"),
    file_prefix=logging_cfg.get("file_prefix"),
)

mkv_module = importlib.import_module("video.mkv_merge_ext_subs")
vid_mkv_merge_ext_subs = mkv_module.vid_mkv_merge_ext_subs
resolve_convert_csvs = mkv_module.resolve_convert_ext_subs_csvs

roots = [Path(p).expanduser() for p in cfg.get("roots", [])]
output_dir = Path(cfg["output_dir"]).expanduser() if cfg.get("output_dir") else None
output_root = Path(cfg["__output_root__"]).expanduser() if cfg.get("__output_root__") else None

definition_override = cfg.get("definition")
csv_parts = cfg.get("csv_part") or []
sources = cfg.get("sources") or ["mkv", "non_mkv"]

if definition_override:
    targets = [Path(definition_override).expanduser()]
else:
    part_sequence = csv_parts if csv_parts else None
    targets = resolve_convert_csvs(roots, output_root, part_sequence, sources)
    if not targets:
        raise SystemExit("Could not locate mkv_ext_subs/vid_ext_subs CSVs (legacy scan_* also accepted) for the requested configuration.")

for definition_path in targets:
    vid_mkv_merge_ext_subs(
        def_file=definition_path,
        output_dir=output_dir,
        dry_run=bool(cfg.get("dry_run", False)),
    )
PY
