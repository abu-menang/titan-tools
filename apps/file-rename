#!/usr/bin/env bash
# Wrapper for file rename workflow using YAML configuration.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
VENV_DIR="${VENV_DIR:-$ROOT_DIR/.venv}"
PYTHON_BIN="${PYTHON_BIN:-python3}"

if [ -d "$VENV_DIR" ]; then
  # shellcheck disable=SC1091
  source "$VENV_DIR/bin/activate"
fi

export PYTHONPATH="${ROOT_DIR}${PYTHONPATH:+:${PYTHONPATH}}"

CONFIG_PATH="${1:-$ROOT_DIR/configs/config.yaml}"
CONFIG_PAYLOAD="$("$PYTHON_BIN" -m common.shared.loader file_rename "$CONFIG_PATH")"

"$PYTHON_BIN" - "$CONFIG_PAYLOAD" <<'PY'
import base64
import json
import importlib
import sys
from pathlib import Path

from common.base.logging import setup_logging

cfg = json.loads(base64.b64decode(sys.argv[1]).decode("utf-8"))
logging_cfg = cfg.pop("__logging__", {}) or {}

setup_logging(
    level=logging_cfg.get("level"),
    use_rich=logging_cfg.get("use_rich"),
    log_dir=logging_cfg.get("log_dir"),
    file_prefix=logging_cfg.get("file_prefix"),
)

renamer_module = importlib.import_module("file.renamer")
rename_from_scan = renamer_module.rename_from_scan
resolve_scan_csvs = renamer_module.resolve_scan_csvs
resolve_output_directory = importlib.import_module("file.utils").resolve_output_directory

roots = [Path(p).expanduser() for p in cfg.get("roots", [])]
if not roots:
    raise SystemExit("file_rename requires at least one root directory")

root = roots[0]
base_name = cfg.get("base_name") or "file_scan"
output_dir = Path(cfg["output_dir"]).expanduser() if cfg.get("output_dir") else None
if output_dir and output_dir.name == "file_rename":
    output_dir = output_dir.parent
elif output_dir is None and cfg.get("__output_root__"):
    output_dir = Path(cfg["__output_root__"]).expanduser()

csv_parts = cfg.get("csv_part") or []
base_output = resolve_output_directory(root, output_dir)

if csv_parts:
    try:
        targets = resolve_scan_csvs(base_output, base_name, csv_parts)
    except FileNotFoundError as exc:
        raise SystemExit(str(exc))
else:
    targets = []

if not targets:
    rename_from_scan(
        root=root,
        csv_file=None,
        output_dir=output_dir,
        base_name=base_name,
        dry_run=bool(cfg.get("dry_run", False)),
    )
else:
    for csv_path in targets:
        rename_from_scan(
            root=root,
            csv_file=csv_path,
            output_dir=output_dir,
            base_name=base_name,
            dry_run=bool(cfg.get("dry_run", False)),
        )
PY
