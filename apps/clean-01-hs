#!/usr/bin/env bash
# Convenience wrapper for running the cleaner workflow targeting the 01_no_sub_mkv directory.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
VENV_DIR="${VENV_DIR:-$ROOT_DIR/.venv}"
PYTHON_BIN="${PYTHON_BIN:-python3}"

if [ -d "$VENV_DIR" ]; then
  # shellcheck disable=SC1091
  source "$VENV_DIR/bin/activate"
fi

export PYTHONPATH="${ROOT_DIR}${PYTHONPATH:+:${PYTHONPATH}}"

CONFIG_PATH="${1:-$ROOT_DIR/configs/config.yaml}"
CONFIG_PAYLOAD="$("$PYTHON_BIN" -m common.shared.loader vid_cleaner "$CONFIG_PATH")"

"$PYTHON_BIN" - "$CONFIG_PAYLOAD" <<'PY'
import base64
import json
import importlib
import logging
import sys
from pathlib import Path

from common.base.logging import setup_logging
from common.shared.loader import load_output_dirs

cfg = json.loads(base64.b64decode(sys.argv[1]).decode("utf-8"))
logging_cfg = cfg.pop("__logging__", {}) or {}
target_dir_key = "no_sub_mkv_dir"
target_dir_name = str(load_output_dirs().get(target_dir_key) or "01_no_sub_mkv")
tracks_root = cfg.get("tracks_root")
output_root_val = tracks_root or cfg.get("__output_root__") or cfg.get("output_root")
output_root = Path(output_root_val) if output_root_val else None
output_dir_cfg = cfg.get("output_dir")
if output_dir_cfg:
    output_dir = Path(output_dir_cfg)
elif output_root:
    output_dir = output_root / target_dir_name
else:
    raise SystemExit("output_dir not provided and tracks_root/__output_root__/output_root missing; cannot continue.")

output_dir = output_dir.expanduser().resolve()
log_dir_override = output_dir / "logs"

use_rich = logging_cfg.get("use_rich")
if isinstance(use_rich, str):
    lowered = use_rich.strip().lower()
    if lowered == "auto":
        use_rich = None
    elif lowered in {"true", "yes", "1", "on"}:
        use_rich = True
    elif lowered in {"false", "no", "0", "off"}:
        use_rich = False

setup_logging(
    level=logging_cfg.get("level"),
    use_rich=use_rich,
    log_dir=str(log_dir_override),
    file_prefix=logging_cfg.get("file_prefix"),
)

log = logging.getLogger("clean_01_hs")
log.info(
    "Config loaded for clean-01-hs (roots=%s, output_dir=%s, target_dir=%s, tracks_root=%s, output_root=%s, dry_run=%s)",
    cfg.get("roots"),
    output_dir,
    target_dir_name,
    tracks_root,
    cfg.get("__output_root__"),
    cfg.get("dry_run"),
)

run_cleaner = importlib.import_module("video.cleaners.cleaner").run_cleaner

if not output_dir.is_dir():
    raise SystemExit(f"output_dir not found: {output_dir}")

run_cleaner(
    roots=[Path(p) for p in cfg.get("roots", [])] or None,
    output_root=output_root,
    output_dir=output_dir,
    dry_run=bool(cfg.get("dry_run", False)),
    clean_dir=target_dir_name,
    extra_tags=["hard_sub"],
)
PY
